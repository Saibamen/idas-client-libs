name: Check WebLibs (NPM)

on:
  workflow_dispatch:
  pull_request:
    paths:
      - 'WebLibs/**'
      - '.github/workflows/check-weblibs.yml'

env:
  WEBLIBS_DIR: WebLibs

jobs:
  check-weblibs:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - uses: actions/setup-node@v4
      with:
        node-version: 18
    - run: npm ci
      working-directory: ${{ env.WEBLIBS_DIR }}
    - run: npm run svelte-check
      working-directory: ${{ env.WEBLIBS_DIR }}
    - run: npm run lint:prod
      working-directory: ${{ env.WEBLIBS_DIR }}
    - run: echo "${{ toJson(github) }}"
      if: ${{ failure() }}
    - name: Send mail if job failed
      if: ${{ failure() }}
      uses: dawidd6/action-send-mail@v3
      with:
        # Specify connection via URL (replaces server_address, server_port, secure,
        # username and password)
        #
        # Format:
        #  * smtp://user:password@server:port
        #  * smtp+starttls://user:password@server:port
        connection_url: ${{ secrets.MAIL_CONNECTION }}
        subject: GitHub Actions WebLibs job failed
        to: ${{ secrets.DEV_EMAIL }}
        from: GitHub Actions
        # Optional plain body:
        body: Build job of ${{ github.repository }} failed! ${{ toJson(github) }}
        # Optional converting Markdown to HTML (set content_type to text/html too):
        convert_markdown: true
